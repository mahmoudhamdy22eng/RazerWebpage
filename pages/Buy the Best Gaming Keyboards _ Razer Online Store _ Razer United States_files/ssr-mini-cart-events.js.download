initLogginCheck();function initLogginCheck(){if(document.cookie.includes('disable-sso-reload')&&localStorage.getItem('spartacus⚿⚿auth')&&localStorage.getItem('razer-avatar')){let info=JSON.parse(localStorage.getItem('spartacus⚿⚿auth'));const avatarData=localStorage.getItem('razer-avatar').split('***');if(avatarData.length===2){info={uuid:info.userId,token_type:info.token.token_type,access_token:info.token.access_token,razerid:avatarData[0],avatar:avatarData[1]};fetchLoggedInUserCartData(info);updateLoggedInUserNavLinks(info);initLogoutEvents();return;}}
window.RzSdk=()=>{const loginCheck=document.body.getAttribute('data-login-check');if(loginCheck){rz.init({client_id:loginCheck,client_key:'',scope:'openid profile cop sso email',});rz.verify();}};window.setInfo=(info)=>{if(info&&!info.error){updateUserStorage(info);fetchLoggedInUserCartData(info);updateLoggedInUserNavLinks(info);initLogoutEvents();}else if(window.localStorage){deleteUserStorage();fetchGuestUserCartData();pushUserData('anonymous');}};}
function pushUserData(userId){window?.dataLayer?.push({userid:userId});}
function updateUserStorage(info){const cookieExpiryTime=new Date(new Date().getTime()+15*60*1000);document.cookie='disable-sso-reload=true; expires='+cookieExpiryTime.toUTCString()+'; path=/';localStorage.setItem('razer-avatar',info.razerid+'***'+(info.avatar||''));const authValue={token:{access_token:info.access_token,token_type:info.token_type},userId:info.uuid,redirectUrl:document.location.pathname};localStorage.setItem('spartacus⚿⚿auth',JSON.stringify(authValue));}
function deleteUserStorage(){localStorage.removeItem('spartacus⚿⚿auth');localStorage.removeItem('razer-avatar');}
function updateLoggedInUserNavLinks(userInfo){const userNavItemsContainer=document.querySelector('app-razer-mini-cart .loggedin-user-nav');if(userInfo.avatar){const loggedInUserIcon=userNavItemsContainer.querySelector('.loggedin-user .icons');loggedInUserIcon.classList.remove('default-avatar-icon');loggedInUserIcon.innerHTML='<img class="bgloginuser avatar" src="'+userInfo.avatar+'" />';}
if(userInfo.razerid){userNavItemsContainer.querySelector('.loggedin-user-id').innerHTML=userInfo.razerid;}
userNavItemsContainer.removeAttribute('hidden');document.querySelector('app-razer-mini-cart .guest-user-nav').setAttribute('hidden','true');getRazerSilverWalletData(userInfo);}
function getRazerSilverWalletData(userInfo){const silverPoints=document.querySelector('app-razer-mini-cart .align-reward-points');if(silverPoints){const silverWalletEndpoint=silverPoints.getAttribute('data-silver-data-url')?.replace('razerSilverUserId',userInfo.uuid);fetch(silverWalletEndpoint,{headers:{'Authorization':userInfo.token_type+' '+userInfo.access_token}}).then(response=>response.json()).then(silverWalletData=>{const razerSilverBalance=silverWalletData?.walletCredit?.silverBalance;if(razerSilverBalance){silverPoints.querySelector('.razer-silver-balance').innerText=((''+razerSilverBalance).replace(/,/g,' '));}});}}
function fetchLoggedInUserCartData(userInfo){const userId=userInfo.uuid;pushUserData(userId);const header={headers:{'Authorization':userInfo.token_type+' '+userInfo.access_token}};fetchCartData(userId,'',header);}
function fetchGuestUserCartData(){let cartId=localStorage.getItem('spartacus⚿⚿cart');if(cartId){cartId=JSON.parse(cartId);cartId=cartId.active;}
if(cartId){fetchCartData('anonymous',cartId,{})}}
function fetchCartData(userId,cartId,header){const currentSite=document.querySelector('cx-storefront')?.getAttribute('data-site');const currentCurrency=document.querySelector('cx-storefront')?.getAttribute('data-currency');const currentLanguage=document.querySelector('cx-storefront')?.getAttribute('data-language');if(currentSite&&currentCurrency&&currentLanguage){const occBaseUrl=window.document.getElementsByName('occ-backend-base-url')[0].getAttribute('content');let url=occBaseUrl+'/rest/v2/'+currentSite+'/users/'+userId+'/carts/'+cartId+'?fields=DEFAULT,entries(product(images(FULL)))&lang='+currentLanguage+'&curr='+currentCurrency+'&refreshCart=false';if(!cartId){url=occBaseUrl+'/rest/v2/'+currentSite+'/users/'+userId+'/carts?fields=carts(DEFAULT,entries(product(images(FULL))))&lang='+currentLanguage+'&curr='+currentCurrency+'&refreshCart=false';}
getCartData({url,header,currentSite,currentCurrency,currentLanguage,occBaseUrl,cartId});}}
function getCartData({url,header,currentSite,currentCurrency,currentLanguage,occBaseUrl,cartId}){fetch(url,header).then(response=>response.json()).then(data=>{if(!data.errors){const carbonUrl=occBaseUrl+'/rest/v2/'+currentSite+'/carbons/uiconfig?lang='+currentLanguage+'&curr='+currentCurrency+'&refreshCart=false';let cartResponseData=data;if(!cartId){cartResponseData=data.carts[0];}
if(cartResponseData&&cartResponseData.entries&&cartResponseData.entries.length<=2&&cartResponseData.opInCarbonCredit){fetch(carbonUrl).then(response=>response.json()).then(carbonData=>{createMiniCart(cartResponseData,carbonData)});}else if(cartResponseData&&cartResponseData.entries&&cartResponseData.entries.length){createMiniCart(cartResponseData,null)}}},err=>{});}
function createMiniCart(cartData,carbonData){const allCartData=getReverseEntryList(cartData.entries,cartData);if(carbonData){allCartData.push({orderEntryType:'CARBON',quantity:1,product:{name:carbonData.productName,image:{altText:carbonData.productName,url:carbonData.productThumbnail}}})}
if(allCartData&&allCartData.length){const allProductsCount=remainingProductsCount(allCartData,0);const miniCartCount=document.querySelector('#icon-nav-cart .count');if(miniCartCount){miniCartCount.innerText=' '+allProductsCount+' ';miniCartCount.classList.remove('count-0');}
document.querySelectorAll('app-razer-mini-cart .cart-products-count')?.forEach(e=>{e.innerText='('+allProductsCount+')';e.removeAttribute('hidden');});}
const entryData=allCartData.slice(0,3);const emptyCartMessageHolder=document.querySelector('app-razer-mini-cart .empty-cart-message');emptyCartMessageHolder.setAttribute('hidden','true');let miniCartItemsHtml=getMiniCartHtml(entryData)
if(allCartData&&allCartData.length>3){const remainingProductsLength=remainingProductsCount(allCartData,3);let remainingProductsCountLabel=document.querySelector('.ssr-only-cart-hr .sigle-product-count-label')?.innerHTML;if(remainingProductsLength>1){remainingProductsCountLabel=document.querySelector('.ssr-only-cart-hr .multiple-product-count-label')?.innerHTML;}
remainingProductsCountLabel=remainingProductsCountLabel.replace('0',remainingProductsLength);miniCartItemsHtml+='<h5 class="over-hr"><span>'+remainingProductsCountLabel+'</span></h5>';}
const cartBtnHtml=document.querySelector('.ssr-only-cart-hr .cart-nav-btn').outerHTML;miniCartItemsHtml+='<div class="col-auto cta-checkout">'+cartBtnHtml+'</div>';const miniCartHolder=document.querySelector('.mini-cart-nav');const productListHolder=document.createElement('div');productListHolder.classList.add('product-detail-minicart');productListHolder.innerHTML=miniCartItemsHtml;miniCartHolder.insertBefore(productListHolder,emptyCartMessageHolder);}
function getMiniCartHtml(entryData){let miniCartItemsHtml='<ul class="list-group">';entryData.forEach(e=>{miniCartItemsHtml+='<li class="list-group-item d-flex justify-content-between align-items-center" role="group" aria-label="product">';miniCartItemsHtml+='<div class="image-parent">';const primaryImageUrl=getThumbUrl(e.product);if(!e.orderEntryType&&primaryImageUrl?.url){miniCartItemsHtml+='<img class="align-self-center" src="'+primaryImageUrl.url+'" alt="'+primaryImageUrl.altText+'">'}else if(e.orderEntryType==='DIGITAL'&&primaryImageUrl?.url){miniCartItemsHtml+=' <img class="align-self-center" src="'+primaryImageUrl.url+'" alt="'+primaryImageUrl.altText+'">';}else if(e.orderEntryType==='CUSTOM'){miniCartItemsHtml+='<img src="'+e?.cgReference?.image?.url+'" alt="'+e?.cgReference?.image?.altText+'">';}else if(e.orderEntryType==='CARBON'){miniCartItemsHtml+='<img class="align-self-center" src="'+e?.product?.image?.url+'" alt="'+e?.product?.image?.altText+'">';}
miniCartItemsHtml+='</div>';miniCartItemsHtml+='<div class="media-body"> <h5 class="mt-0">'+e?.product?.name+'</h5>';if(e.quantity>1){miniCartItemsHtml+='<p class="mb-0 item-qty" *ngIf="">x '+e?.quantity+'</p>';}
miniCartItemsHtml+='</div>';miniCartItemsHtml+='</li>';});miniCartItemsHtml+='</ul>';return miniCartItemsHtml;}
function getReverseEntryList(products,cart){const sortedProducts=reOrder(products,null,true).reverse();const updatedCartProducts=[];const nonWarrantyProducts=sortedProducts.filter(item=>(!item.product.isWarranty));nonWarrantyProducts?.forEach((item)=>{let warranty;cart?.warrantyInfo?.forEach((currentWarranty)=>{if(currentWarranty.productCode===item.product.code){warranty=currentWarranty;}});updatedCartProducts.push(item);if(cart&&cart.warrantyInfo&&cart.warrantyInfo.length&&warranty&&warranty.warranties){const addedWarranties=warranty.warranties.filter(entry=>(entry.entryNumber||entry.entryNumber===0));addedWarranties.forEach(w=>{updatedCartProducts.push(products[w.entryNumber]);});}});return updatedCartProducts;}
function reOrder(items,cart=null,reverseOrder=false){let toOrderMap=new Map();const orderedItems=[];items.forEach(item=>{const hash=item.giftingProductCode||item.product.code;if(toOrderMap.has(hash)){toOrderMap=validateReverseOrderItems(reverseOrder,item,toOrderMap,hash);}else{toOrderMap.set(hash,[item]);}});const iterable=toOrderMap.entries();let entry=iterable.next();while(!entry.done){entry.value[1].forEach(item=>orderedItems.push(item));entry=iterable.next();}
return orderedItems;}
function validateReverseOrderItems(reverseOrder,item,toOrderMap,hash){if(reverseOrder){if(!item.giftingProductCode){toOrderMap.get(hash).push(item);}else{toOrderMap.get(hash).unshift(item);}}else{if(!item.giftingProductCode){toOrderMap.get(hash).unshift(item);}else{toOrderMap.get(hash).push(item);}}
return toOrderMap;}
function remainingProductsCount(entries,count){let qty=0;let newEntries=entries;if(count){newEntries=entries.slice(3);}
newEntries.forEach(item=>{qty+=Number(item.quantity);});return qty;}
function getThumbUrl(product){return product?.images?.find(i=>i.format==='thumbnail')||''}
function initLogoutEvents(){document.querySelector('.razer-logout-button').addEventListener('click',(e)=>{e.preventDefault();const externalLogout=document.body.getAttribute('data-logout-external');const internalLogout=document.body.getAttribute('data-logout-internal');const currentCurrency=document.querySelector('cx-storefront')?.getAttribute('data-currency');const currentLanguage=document.querySelector('cx-storefront')?.getAttribute('data-language');const ifrm=document.createElement('iframe');ifrm.setAttribute('src',externalLogout);ifrm.style.width='0';ifrm.style.height='0';ifrm.onload=()=>{fetch(internalLogout+'?lang='+currentLanguage+'&curr='+currentCurrency).then(()=>{localStorage.removeItem('razerid_token');localStorage.removeItem('razerid_expiry');localStorage.removeItem('spartacus⚿⚿auth');localStorage.removeItem('spartacus⚿⚿cart');document.location.reload();});};document.body.appendChild(ifrm);});}